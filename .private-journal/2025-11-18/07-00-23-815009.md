---
title: "7:00:23 AM - November 18, 2025"
date: 2025-11-18T15:00:23.815Z
timestamp: 1763478023815
---

## Project Notes

## Riverpod Disposed Ref Crash Fix

Successfully fixed "Cannot use Ref after disposed" crashes in commentsProvider and fetchProfileStatsProvider.

### Issue Summary
- **240 events, 126 users affected**
- **Type**: NON_FATAL but **breaks UI** (comments fail to load, stats show stale data)
- **Root Cause**: Accessing `ref` or `state` after async gaps without checking `ref.mounted`

### Affected Providers

**1. CommentsProvider** (`lib/providers/comments_provider.dart`)
- **Line 120**: Stream listener updating state without mounted check
- **Line 163**: `Future.delayed` (3 seconds) updating state after provider disposed
- **Line 133**: Error handler updating state without mounted check

**2. FetchProfileStatsProvider** (`lib/providers/profile_stats_provider.dart`)
- **Line 104**: After `await subscribeToUserVideos()`
- **Line 107**: After `await getFollowerStats()`
- **Line 132**: After `await _cacheProfileStats()`

### Fix Strategy

Added `ref.mounted` checks after EVERY async gap:
1. Stream listener callbacks
2. Future.delayed callbacks
3. After every `await` statement
4. Error handlers

### Code Pattern

```dart
// Before (CRASH)
await someAsyncOperation();
state = newState; // CRASH if provider disposed during await

// After (SAFE)
await someAsyncOperation();
if (!ref.mounted) {
  Log.debug('Provider disposed...');
  return; // or throw StateError
}
state = newState; // Safe - provider still alive
```

### Files Modified
- `lib/providers/comments_provider.dart`: Added 3 ref.mounted checks
- `lib/providers/profile_stats_provider.dart`: Added 3 ref.mounted checks

### Why This Breaks UI

**CommentsProvider**:
- Comments screen opens
- Starts loading comments
- User navigates away quickly (< 3 seconds)
- Provider disposes
- Future.delayed fires → tries to update disposed state
- Result: Comment loading fails silently, users see empty comments

**ProfileStatsProvider**:
- Profile screen loads stats
- Awaits video subscription, follower count
- User navigates away mid-load
- Provider disposes
- Async operations complete → try to return/cache stats
- Result: Stats don't update, shows stale/0 counts

### Testing Impact

This fix prevents:
1. Silent failures in comments loading
2. Stale profile stats displays
3. Error toasts/snackbars from disposed provider access
4. UI freezes from state update errors

---
title: "6:19:59 AM - November 18, 2025"
date: 2025-11-18T14:19:59.232Z
timestamp: 1763475599232
---

## Project Notes

## AVFoundationVideoPlayer Crash Root Cause

**Issue**: `Could not find corresponding view type for playerId: X` causing FATAL crashes (67 events, 57 users)

**Root Cause Identified**: Race condition between widget rebuild and native platform view lifecycle

### The Problem

1. **Disposal in microtask**: Controller disposal happens asynchronously in `Future.microtask()` (individual_video_providers.dart:391-398)
2. **Rapid navigation**: Camera ↔ Explore screen transitions trigger fast widget mount/unmount cycles
3. **Platform view mismatch**: VideoPlayer widget tries to build before native view is ready or after it's destroyed

### Technical Flow

```
User navigates: Explore → Camera → Explore (rapid)
├─ Explore unmounts → isActive=false → provider starts disposal
├─ Provider.onDispose() schedules controller.dispose() in microtask
├─ User taps back quickly → Explore mounts again
├─ New widget builds → reads same controller provider (keepAlive cache)
├─ VideoPlayer(controller) renders → calls buildViewWithOptions
└─ ERROR: Native playerId view was destroyed or not created yet
```

### Key Code Locations

- **Controller Provider**: `mobile/lib/providers/individual_video_providers.dart:100-406`
  - Line 108-123: keepAlive with 5-minute cache (prevents codec churn)
  - Line 381-399: onDispose with microtask disposal (THE PROBLEM)
  
- **VideoPlayer Widget**: `mobile/lib/widgets/video_feed_item.dart:439`
  - Conditional rendering based on `isActive`
  - No defensive checks for controller state

### Why It Happens

The 5-minute keepAlive cache (line 108) is excellent for performance but creates a window where:
- Widget thinks controller is valid (cached)
- Native platform view was disposed
- Rebuild happens before native view recreates

### Crashlytics Pattern

From crash logs:
- Always from `explore_screen` ↔ `camera` navigation breadcrumbs
- Various playerId values (1, 4, 11, 31, 32) - not a specific instance leak
- Happens during widget rebuild: `_VideoPlayerState.build` → `AVFoundationVideoPlayer.buildViewWithOptions`

### Solution Approaches

1. **Defensive rendering**: Check controller.value.isInitialized before rendering VideoPlayer widget
2. **Synchronous disposal**: Don't use Future.microtask, dispose immediately
3. **Platform view state tracking**: Add native view existence check before buildViewWithOptions
4. **Widget key management**: Force new VideoPlayer instance on remount with unique keys

Need to decide which approach to take.

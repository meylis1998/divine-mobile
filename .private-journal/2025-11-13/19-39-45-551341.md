---
title: "7:39:45 PM - November 13, 2025"
date: 2025-11-13T19:39:45.551Z
timestamp: 1763062785551
---

## Project Notes

**Age Gate Race Condition - FIXED**

Successfully debugged and fixed the race condition where users couldn't accept the terms of service on WelcomeScreen.

**Root Cause**: 
- WelcomeScreen was watching `authServiceProvider` (the AuthService instance)
- When auth state changed, only StreamController emitted events
- The AuthService instance itself didn't change â†’ Riverpod didn't rebuild the UI
- Result: Button never appeared even after auth completed

**Fix Applied**:
1. Created `authStateStreamProvider` in app_providers.dart (lines 228-239)
   - Uses `async*` generator to emit current state immediately, then stream future changes
2. Updated WelcomeScreen to watch `authStateStreamProvider` instead of `authService.authState` (lines 29-39)
   - Uses `.when()` to handle loading/error states properly
3. Added TDD test for race condition (welcome_screen_auth_state_test.dart)
   - Test simulates auth state changing after widget build
   - Confirms UI rebuilds when auth completes

**Files Changed**:
- mobile/lib/providers/app_providers.dart - Added authStateStreamProvider
- mobile/lib/screens/welcome_screen.dart - Watch stream instead of service property  
- mobile/lib/providers/social_providers.dart - Fixed compilation errors (missing socialService refs)
- mobile/test/screens/welcome_screen_auth_state_test.dart - Added race condition test, updated all tests to mock stream provider

**Pattern to Remember**: When using StreamController in a service, widgets must watch a StreamProvider, not the service property directly. The service instance doesn't change when internal state changes.

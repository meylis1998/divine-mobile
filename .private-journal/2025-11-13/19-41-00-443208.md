---
title: "7:41:00 PM - November 13, 2025"
date: 2025-11-13T19:41:00.443Z
timestamp: 1763062860443
---

## Project Notes

**CRITICAL BUG FOUND**: Loading screen hangs due to `addPostFrameCallback` deadlock in AuthService

**Root Cause**:
In `auth_service.dart` `_checkExistingAuth()` method:
- Lines 531-532, 547-549, 554-556: Wraps `_setAuthState()` calls in `addPostFrameCallback`
- If auth initialization fails, state change to `unauthenticated` is deferred until next frame
- BUT welcome screen shows CircularProgressIndicator while in `checking` or `authenticating` states
- If loading spinner is shown, no frames may be rendered, so callback never fires
- Result: User stuck on loading screen indefinitely

**Why This Happens**:
1. App starts, authService.initialize() sets state to `checking`
2. Welcome screen watches authStateStreamProvider, gets `checking`, shows spinner
3. _checkExistingAuth() runs, if createNewIdentity() fails, tries to set `unauthenticated` via addPostFrameCallback
4. But since spinner is blocking frame renders, callback never executes
5. Stream never emits new state, welcome screen stuck showing loading spinner forever

**The Fix**:
Remove `addPostFrameCallback` wrappers in _checkExistingAuth() error handlers (lines 547-549, 554-556) and line 531-532 (redundant since createNewIdentity calls it immediately anyway). Set auth state synchronously.

**Files Affected**:
- mobile/lib/services/auth_service.dart (lines 530-556)

---
title: "4:13:28 AM - November 16, 2025"
date: 2025-11-16T04:13:28.229Z
timestamp: 1763266408229
---

## Project Notes

**BLACK SCREEN BUG - ROOT CAUSE HYPOTHESIS (Nov 16, 2025)**

## Evidence Gathered

1. **Relay confirmation fix IS implemented** (profile_setup_screen.dart:863-950)
   - Uses AsyncUtils.retryWithBackoff properly
   - Confirms profile update before navigating
   - This was the FIX for the original race condition

2. **But users still report black screens** - different root cause!

## New Hypothesis: Provider Invalidation + Navigation Timing

**The Flow:**
1. ProfileSetupScreen line 943: `ref.invalidate(fetchUserProfileProvider(currentPubkey));`  
2. This invalidation triggers ProfileScreenRouter (still mounted in background) to rebuild
3. Line 997: `Navigator.of(context).pop(true);` - pops setup screen
4. During navigation transition, profile screen is revealed mid-rebuild
5. **GAP**: Brief moment where screen renders before provider finishes reloading

**Critical Code:**
- profile_screen_router.dart:471: `final profileAsync = ref.watch(fetchUserProfileProvider(userIdHex));`
- profile_screen_router.dart:472: `final profile = profileAsync.value;` 
- **NOT wrapped in buildAsyncUI** - just accesses `.value` directly
- When invalidated, `.value` is null, but widgets handle null safely

## Competing Theories

**Theory A: Timing gap during invalidation + navigation**
- Provider invalidated while setup screen still visible
- Profile screen rebuilds in background
- Navigation reveals screen mid-rebuild â†’ brief black flash

**Theory B: AppShell Scaffold missing explicit backgroundColor**
- app_shell.dart:134 - Scaffold has no `backgroundColor` parameter
- Relies on theme's `scaffoldBackgroundColor` (black)
- During navigation transitions, theme might not apply instantly

**Theory C: Loading states don't have Scaffold wrappers**
- Lines 405-429, 435-460 in ProfileScreenRouter
- Just `Center(child: Column(...))` - no Scaffold
- Rely on parent AppShell Scaffold for background
- During navigation, parent might not be ready yet

## Most Likely Root Cause

**Theory A + Theory B combined**: The provider invalidation happens BEFORE navigation, causing the profile screen to enter a loading/rebuilding state while still in the background. When the navigation completes and reveals the profile screen, there's a brief moment where the widgets haven't fully rendered yet, showing just the black Scaffold background without content.

## Next Steps

Need to test this hypothesis by:
1. Moving provider invalidation to AFTER navigation completes
2. OR adding explicit Scaffold wrappers to loading states
3. OR waiting for provider to reload before navigating


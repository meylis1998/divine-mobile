---
title: "10:24:13 AM - December 2, 2025"
date: 2025-12-01T21:24:13.840Z
timestamp: 1764624253840
---

## Project Notes

## Age-Gate Bug Fix (2025-12-02)

### Root Cause
The `ageVerificationServiceProvider` was configured as autoDispose, causing it to be disposed when widgets stopped watching it. When recreated, the service's in-memory `_isAdultContentVerified` state was lost (null, defaulting to false) until `initialize()` completed loading from SharedPreferences. But `initialize()` was NOT awaited, creating a race condition where checks happened before state was loaded.

### Fix
Changed from `@riverpod` to `@Riverpod(keepAlive: true)` in `lib/providers/app_providers.dart`:
```dart
@Riverpod(keepAlive: true)
AgeVerificationService ageVerificationService(Ref ref) {
  final service = AgeVerificationService();
  service.initialize(); // Initialize asynchronously
  return service;
}
```

### Key Insight
The `keepAlive: true` annotation prevents automatic disposal when no widgets are watching, ensuring the singleton persists for the app's lifetime. This means the in-memory verification state is preserved after user verifies their age.

### Testing Lesson
`container.invalidate()` forces provider recomputation regardless of keepAlive - it tests different behavior than autoDispose. To test keepAlive vs autoDispose, test that multiple reads return the same instance and state persists.

### Files Modified
- `lib/providers/app_providers.dart` - Added keepAlive: true to ageVerificationServiceProvider
- `lib/providers/app_providers.g.dart` - Regenerated with isAutoDispose: false
- `lib/widgets/video_error_overlay.dart` - Added diagnostic logging for age-gate flow
- `lib/providers/individual_video_providers.dart` - Added logging to _computeAuthHeadersSync
- `test/providers/age_verification_provider_test.dart` - New test file for provider behavior

---
title: "12:30:13 PM - November 8, 2025"
date: 2025-11-08T04:30:13.876Z
timestamp: 1762576213876
---

## Project Notes

**Implemented Database-Backed Sorted Video Queries**

Successfully implemented a complete solution for database-level sorted video queries to fix the Trending tab showing low-loop-count videos instead of high-loop-count videos.

**Root Cause**:
- Cache-first loading was using `ORDER BY created_at DESC` instead of sorting by engagement metrics
- Engagement metrics (loop_count, likes, comments) were stored in JSON tags, not as database columns
- Database couldn't efficiently sort by JSON fields

**Solution Implemented**:

1. **Created VideoMetrics table** (schema v4):
   - Denormalized cache of engagement metrics from video event tags
   - Columns: event_id, loop_count, likes, views, comments, avg_completion, verification flags, updated_at
   - Foreign key to event table with CASCADE delete
   - Indices on loop_count, likes, views for fast sorted queries

2. **Created VideoMetricsDao**:
   - `upsertVideoMetrics(Event)`: Parse VideoEvent and insert/update metrics row
   - `batchUpsertVideoMetrics(List<Event>)`: Batch processing for multiple events
   - Currently populates loop_count, likes, comments (views and other fields set to NULL until we extract them)

3. **Updated NostrEventsDao**:
   - Modified `upsertEvent()` to automatically call VideoMetricsDao for video events (kind 34236, 6)
   - Added VideoMetrics to accessor tables list
   - Updated `getVideoEventsByFilter()` to support `sortBy` parameter
   - LEFT JOIN with video_metrics table when sorting by engagement metrics
   - ORDER BY uses `COALESCE(m.loop_count, 0) DESC` to handle NULL values

4. **Updated VideoEventService**:
   - Modified `_loadCachedEvents()` to accept `VideoSortField? sortBy` parameter
   - Passes sortBy to DAO's `getVideoEventsByFilter()`
   - Updated `subscribeToVideoFeed()` call sites to pass sortBy parameter

5. **Fixed Test File Syntax Errors**:
   - Fixed missing commas in test/providers/vine_recording_ui_state_test.dart
   - Fixed missing commas in test/widgets/camera_recording_ui_hints_test.dart
   - These were blocking build_runner code generation

**Architecture Benefits**:
- Cache queries now return properly sorted results instantly
- No need to parse JSON tags on every query
- Database indices make sorted queries fast even with thousands of events
- Metrics automatically updated when events are stored

**Testing Plan**:
- Need to test Trending tab shows videos sorted by loop_count DESC
- Verify high-loop-count videos (100M+) appear first
- Check cache query performance with large datasets
- Confirm metrics are populated for new and existing events

**Technical Details**:
- VideoEvent model only has originalLoops, originalLikes, originalComments (nullable ints)
- views, avgCompletion, and verification flags not yet extracted from tags
- Migration handles upgrade from v3â†’v4 automatically
- All code generation successful with build_runner

